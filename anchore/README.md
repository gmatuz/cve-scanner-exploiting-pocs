# Running OS commands through docker manifests
The issue was introduced in version 0.7 and fixed in 0.7.1 so pick 0.7 if you want to test it.
As you can see Anchore uses [shell callout](https://github.com/anchore/anchore-engine/blob/v0.7.0/anchore_engine/clients/skopeo_wrapper.py#L130) to `skopeo` to manipulate docker images 
```py
cmd = ["/bin/sh", "-c", "skopeo {} {} copy {} {} docker://{} dir:{}".format(os_override_str, global_timeout_str, tlsverifystr, credstr, fulltag, copydir)]
```
One of the parameters that are getting passed is the `os_override` that comes from `os` field of the [manifest.json](https://github.com/anchore/anchore-engine/blob/v0.7.0/anchore_engine/clients/skopeo_wrapper.py#L106) of the docker image.
```py
                for mlist in parent_manifest_data.get('manifests', []):
                    imageos = mlist.get('platform', {}).get('os', "")
                    if imageos not in ["", 'linux'] and imageos not in os_overrides:
                        dest_type = 'dir'
                        os_overrides.insert(0, imageos)
```                        
There is a [regexp](https://github.com/anchore/anchore-engine/blob/v0.7.0/anchore_engine/utils.py#L194) that looks for shell characters; however, it misses for example expansion `$(echo "hacked")` 
```py
def run_sanitize(cmd_list):
    def shellcheck(x):
        if not re.search("[;&<>]", x):
            return(x)
        else:
            raise Exception("bad character in shell input")
```

# Exploitation
So in order to exploit this you need to publish a manifest for an image that you then add to Anchore with `anchore-cli image add`
To create such a manifest:
1. You need to enable experimental features in the Docker CLI, edit the `config.json` and set experimental to `enabled`
2. Build images that you will [combine in a multi-arch image manifest](https://medium.com/@mauridb/docker-multi-architecture-images-365a44c26be6). 
3. Then create the combined manifest with [docker manifest create](https://docs.docker.com/engine/reference/commandline/manifest/#manifest-create). You will get manifest not found unless you docker pushed and pulled the base images.
4. Then you need some black magic to modify the manifest that you just pushed. Most registries will freak out if you put something weird in the `os` field so I found it easiest to push the manifest as is and modify it on the registry
5. I used Artifactory as a registry where as an admin you are able to change files, so I just edited the `os` [field of the manifest](https://github.com/gmatuz/cve-scanner-pocs/blob/master/anchore/manifest.json#L19), fixed up the sha hash of the file to fit the adjusted manifest. 
```json
            "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
            "size": 528,
            "digest": "sha256:1ee910a8cd99f69ef9a800947a5ec4327f6c5be581c1a595ac610e5ff45c1336",
            "platform": {
                "architecture": "amd64",
                "os": "$(touch hacked_anchore)"
```

These are all necessary for the exploit to run as skopeo will error before running the code if the sha of the manifest is not correct or if the images in the manifest are not there. The manifest file here serves just as an example it does not work as a PoC without creating the images and fixing up the manigest.json in the registry. 
